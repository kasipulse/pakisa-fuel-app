<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digital Fuel Voucher System</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body>
  <h2>Digital Fuel Voucher System</h2>

  <form id="voucherForm">
    <label for="driver">Driver:</label>
    <select id="driver" required></select><br><br>

    <label for="vehicle">Vehicle:</label>
    <select id="vehicle" required></select><br><br>

    <label for="amount">Amount (R):</label>
    <input type="number" id="amount" required><br><br>

    <button type="submit">Create Voucher</button>
  </form>

  <h3>Existing Vouchers</h3>
  <div id="voucherList">Loading vouchers...</div>

  <script>
    const supabaseUrl = "https://sfvoptdderulwrpdywmb.supabase.co";
    const supabaseKey = "YOUR_ANON_KEY"; // Replace with your real anon key
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    async function loadDropdowns() {
      // Load drivers
      let { data: drivers, error: driverError } = await supabaseClient
        .from("drivers")
        .select("id, name, phone_number");

      if (driverError) {
        console.error(driverError);
      } else {
        const driverSelect = document.getElementById("driver");
        driverSelect.innerHTML = "";
        drivers.forEach((d) => {
          let option = document.createElement("option");
          option.value = d.id;
          option.text = `${d.name} (${d.phone_number})`;
          driverSelect.appendChild(option);
        });
      }

      // Load vehicles
      let { data: vehicles, error: vehicleError } = await supabaseClient
        .from("vehicles")
        .select("id, reg_number");

      if (vehicleError) {
        console.error(vehicleError);
      } else {
        const vehicleSelect = document.getElementById("vehicle");
        vehicleSelect.innerHTML = "";
        vehicles.forEach((v) => {
          let option = document.createElement("option");
          option.value = v.id;
          option.text = v.reg_number;
          vehicleSelect.appendChild(option);
        });
      }
    }

    async function loadVouchers() {
      let { data: vouchers, error } = await supabaseClient
        .from("fuel_vouchers")
        .select("id, amount_rand, created_at, drivers(name), vehicles(reg_number)")
        .order("created_at", { ascending: false });

      const voucherList = document.getElementById("voucherList");
      if (error) {
        console.error(error);
        voucherList.innerHTML = "Error loading vouchers.";
        return;
      }

      if (vouchers.length === 0) {
        voucherList.innerHTML = "No vouchers yet.";
        return;
      }

      voucherList.innerHTML = "<ul>" + vouchers.map(
        v => `<li>Driver: ${v.drivers?.name}, Vehicle: ${v.vehicles?.reg_number}, Amount: R${v.amount_rand}, Date: ${new Date(v.created_at).toLocaleString()}</li>`
      ).join("") + "</ul>";
    }

    document.getElementById("voucherForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const driver = document.getElementById("driver").value;
      const vehicle = document.getElementById("vehicle").value;
      const amount = document.getElementById("amount").value;

      const { error } = await supabaseClient.from("fuel_vouchers").insert([
        { driver_id: driver, vehicle_id: vehicle, amount_rand: amount }
      ]);

      if (error) {
        alert("Error creating voucher: " + error.message);
      } else {
        alert("Voucher created!");
        loadVouchers();
      }
    });

    loadDropdowns();
    loadVouchers();
  </script>
</body>
</html>
