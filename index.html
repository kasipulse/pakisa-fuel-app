<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pakisa Fuel Voucher</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    h2 { color: #0a2b52; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; }
    input, select, button {
      width: 100%; padding: 10px; margin-top: 3px;
    }
    button {
      background: #0a2b52; color: white; border: none; cursor: pointer;
    }
    button:hover { background: #409dbc; }
    #message { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Fuel Voucher</h2>

  <div class="form-group">
    <label for="driver">Driver</label>
    <select id="driver"></select>
  </div>

  <div class="form-group">
    <label for="vehicle">Vehicle</label>
    <select id="vehicle"></select>
  </div>

  <div class="form-group">
    <label for="amount">Amount (R)</label>
    <input type="number" id="amount" />
  </div>

  <button onclick="createVoucher()">Create Voucher</button>

  <p id="message"></p>

  <script>
    // ✅ Supabase connection
    const supabaseUrl = "https://sfvoptdderulwrpdywmb.supabase.co";
    const supabaseKey = "YOUR_PUBLIC_ANON_KEY"; // replace with anon key from Supabase
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // ✅ Function URL (your deployed Supabase Edge Function for SMS)
    const smsFunctionUrl = "https://sfvoptdderulwrpdywmb.functions.supabase.co/rapid-api";

    async function loadDropdowns() {
      // Load drivers
      const { data: drivers, error: driversError } = await supabase.from("drivers").select("*");
      if (driversError) {
        console.error("Error loading drivers:", driversError);
        return;
      }
      const driverSelect = document.getElementById("driver");
      drivers.forEach(d => {
        driverSelect.innerHTML += `<option value="${d.id}" data-phone="${d.phone}">${d.name}</option>`;
      });

      // Load vehicles
      const { data: vehicles, error: vehiclesError } = await supabase.from("vehicles").select("*");
      if (vehiclesError) {
        console.error("Error loading vehicles:", vehiclesError);
        return;
      }
      const vehicleSelect = document.getElementById("vehicle");
      vehicles.forEach(v => {
        vehicleSelect.innerHTML += `<option value="${v.id}">${v.reg_number}</option>`;
      });
    }

    async function sendSMS(phone, message) {
      const response = await fetch(smsFunctionUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone, message })
      });
      return response.json();
    }

    async function createVoucher() {
      const driverSelect = document.getElementById("driver");
      const driverId = driverSelect.value;
      const driverPhone = driverSelect.options[driverSelect.selectedIndex].dataset.phone;

      const vehicleId = document.getElementById("vehicle").value;
      const amount = parseFloat(document.getElementById("amount").value);

      if (amount > 1000) {
        if (!confirm("This amount is above R1000. Approve?")) {
          document.getElementById("message").innerText = "Voucher not saved.";
          return;
        }
      }

      const { error } = await supabase.from("fuel_vouchers").insert([
        { driver_id: driverId, vehicle_id: vehicleId, amount_rand: amount }
      ]);

      if (error) {
        document.getElementById("message").innerText = "Error: " + error.message;
        return;
      }

      // Build SMS
      const vehicleReg = document.getElementById("vehicle").options[document.getElementById("vehicle").selectedIndex].text;
      const msg = `Pakisa Fuel Voucher: R${amount} approved for vehicle ${vehicleReg} on ${new Date().toLocaleDateString()}. Show this SMS at depot.`;

      await sendSMS(driverPhone, msg);

      document.getElementById("message").innerText = "Voucher created & SMS sent successfully!";
    }

    loadDropdowns();
  </script>
</body>
</html>
