<!DOCTYPE html>
<html>
<head>
  <title>Pakisa Fuel Voucher</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; }
    input, select, button { width: 100%; padding: 10px; }
    button { background: #0a2b52; color: white; border: none; cursor: pointer; }
    button:hover { background: #409dbc; }
    #message { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Fuel Voucher</h2>

  <div class="form-group">
    <label for="driver">Driver</label>
    <select id="driver"></select>
  </div>

  <div class="form-group">
    <label for="vehicle">Vehicle</label>
    <select id="vehicle"></select>
  </div>

  <div class="form-group">
    <label for="amount">Amount (R)</label>
    <input type="number" id="amount" />
  </div>

  <button onclick="createVoucher()">Create Voucher</button>

  <p id="message"></p>

  <script>
    const supabaseUrl = "https://sfvoptdderulwrpdywmb.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmdm9wdGRkZXJ1bHdycGR5d21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNzY4NjAsImV4cCI6MjA3Mzc1Mjg2MH0.bHy_aZ9TOGLfanG6-xNb3HykxwpWAiUNOcfBbvN-OME";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Supabase function URL
    const smsFunctionUrl = "https://sfvoptdderulwrpdywmb.functions.supabase.co/rapid-api";

    async function loadDropdowns() {
      const { data: drivers, error: driversError } = await supabase.from("drivers").select("*");
      const { data: vehicles, error: vehiclesError } = await supabase.from("vehicles").select("*");

      if (driversError || vehiclesError) {
        console.error(driversError || vehiclesError);
        return;
      }

      const driverSelect = document.getElementById("driver");
      drivers.forEach(d => driverSelect.innerHTML += `<option value="${d.id}" data-phone="${d.phone}">${d.name}</option>`);

      const vehicleSelect = document.getElementById("vehicle");
      vehicles.forEach(v => vehicleSelect.innerHTML += `<option value="${v.id}">${v.reg_number}</option>`);
    }

    async function sendSMS(phone, message) {
      const response = await fetch(smsFunctionUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone, message })
      });
      return response.json();
    }

    async function createVoucher() {
      const driverSelect = document.getElementById("driver");
      const driverId = driverSelect.value;
      const driverPhone = driverSelect.options[driverSelect.selectedIndex].dataset.phone;

      const vehicleId = document.getElementById("vehicle").value;
      const amount = parseFloat(document.getElementById("amount").value);

      if (amount > 1000 && !confirm("Amount above R1000. Approve?")) {
        document.getElementById("message").innerText = "Voucher not saved.";
        return;
      }

      const { error } = await supabase.from("fuel_vouchers").insert([
        { driver_id: driverId, vehicle_id: vehicleId, amount_rand: amount }
      ]);

      if (error) {
        document.getElementById("message").innerText = "Error: " + error.message;
        return;
      }

      const vehicleReg = document.getElementById("vehicle").options[document.getElementById("vehicle").selectedIndex].text;
      const message = `Pakisa Fuel Voucher: R${amount} approved for vehicle ${vehicleReg} on ${new Date().toLocaleDateString()}. Show this SMS at depot.`;

      const smsResult = await sendSMS(driverPhone, message);

      document.getElementById("message").innerText = smsResult.success
        ? "Voucher created & SMS sent successfully!"
        : "Voucher created, but SMS failed: " + JSON.stringify(smsResult);
    }

    loadDropdowns();
  </script>
</body>
</html>
